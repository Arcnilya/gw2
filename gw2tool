#!/usr/bin/python3.6
import sys, os, json, argparse, urllib, requests
from urllib.error import HTTPError, URLError
from socket import timeout

URL = "https://api.guildwars2.com/v2/"
API_KEY = "?access_token="

def load_api_key():
	with open("api_key", 'r') as key_file:
		global API_KEY
		API_KEY = API_KEY + key_file.readline().rstrip()

def url2json(target_url):
	try:
		response = requests.get(target_url, timeout=10).text
	except HTTPError as error:
		logging.error('Data of %s not retrieved because %s\nURL: %s', name, error, url)
	except URLError as error:
		if isinstance(error.reason, timeout):
			logging.error('socket timed out - URL %s', url)
		else:
			logging.error('some other error happened')
	else:
		return json.loads(response)


def get_characters():
	return url2json(URL + "characters" + API_KEY)


def get_itemlist(items):
	return url2json(URL + "items?ids=" + ",".join(items))

def print_item(item):
	# Todo: consumables do not have rarities
	print("{} \nLink: {} Rarity: {}\n".format(item['name'], item['chat_link'], item['rarity']))

def find_character(substring):
	char_list = get_characters()
	character = ""
	chars_found = 0
	for char in char_list:
		if substring.lower() in str(char).lower():
			character = str(char)
			chars_found += 1
	if chars_found == 0:
		exit("character not found")
	if chars_found > 1:
		exit("found {} characters".format(chars_found))

	print("found character: {}".format(character))
	return character
	

def inventory(args):
	if len(args) < 1:
		exit("Usage: gw2tool inventory <character>")

	character = find_character(args[0])

	# urllib.parse.quote to handle spaces in character names (firstname lastname) and weird letters?
	inventory = url2json(URL + "characters/" + urllib.parse.quote(character) + "/inventory" + API_KEY)
	
	item_ids = []
	item_amounts = []

	for bag in inventory['bags']:
		for item in bag['inventory']:
			if item is not None:
				item_ids.append(str(item['id']))
				item_amounts.append(str(item['count']))
	inventory_items = get_itemlist(item_ids) 
	
	index = 0
	for item in inventory_items:
		print("{}x {}".format(item_amounts[index], item['name']))
		index += 1

def equipment(args):
	print("equipment")
	if len(args) < 1:
		exit("Usage: gw2tool equipment <character>")

	character = find_character(args[0])
	char_equipment = url2json(URL + "characters/" + urllib.parse.quote(character) + "/equipment" + API_KEY)
	item_ids = []
	item_slots = []

	for item in char_equipment['equipment']:
		item_ids.append(str(item['id']))
		item_slots.append(item['slot'])
	equipment_items = get_itemlist(item_ids)

	index = 0
	for item in equipment_items:
		print("{}: ".format(item_slots[index]), end='')
		print_item(item)
		index += 1


def bank(args):
	print("bank")

def account(args):
	print("account")

def characters(args):
	if len(args) < 1:
		exit("Usage: gw2tool characters <parameter(s)>")
	
	if str(args[0]) == "list":
		print(*get_characters(), sep='\n')


def main():
	
	commands = {
		'inventory': inventory,
		'equipment': equipment,
		'bank': bank,
		'account': account,
		'characters': characters,
		}
	
	if len(sys.argv) < 2:
		exit("Usage: gw2tool <command> <parameter(s)>")

	if not sys.argv[1] in commands.keys():
		exit("Command not found")

	load_api_key()
	commands[sys.argv[1]](sys.argv[2:])

if __name__ == "__main__":
		main()
